{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="card p-4 shadow-sm">
        <h2 class="mb-4">Pagos Registrados</h2>

        <div class="card p-3 mb-3 bg-light">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filtro_year" class="form-label">Filtrar por A√±o</label>
                    <select id="filtro_year" class="form-select">
                        <option value="">Todos los a√±os</option>
                        {% for year in unique_years %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtro_month" class="form-label">Filtrar por Mes</label>
                    <select id="filtro_month" class="form-select">
                        <option value="">Todos los meses</option>
                        {% for num, nombre in months_map.items() %}
                            <option value="{{ num }}">{{ nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-secondary w-100" id="btn_reset_filtros">Limpiar Filtros</button>
                </div>
            </div>
        </div>

        <div class="alert alert-secondary d-flex justify-content-between align-items-center py-2 mb-3">
            <span class="fw-bold"><i class="fa-solid fa-chart-line me-2"></i>Resumen de los registros visibles:</span>
            <span class="fs-5">
                Total Pagado: <span class="badge bg-success fs-5" id="totalMontoGlobal">$ 0.00</span>
            </span>
        </div>
        
        <div class="table-responsive mt-3">
            <table id="tablaPagosGlobal" class="table table-striped table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th class="card-header text-center">ID Pago</th> 
                        <th class="card-header text-center">ID GUMI</th>
                        <th class="card-header text-center">SERVER</th>
                        <th class="card-header text-center">PA√çS</th>
                        <th class="card-header text-center">NEGOCIO</th>
                        <th class="card-header text-center">CONTACTO</th>
                        <th class="card-header text-center">FECHA PAGO</th>
                        <th class="card-header text-center">PAQUETE</th>
                        <th class="card-header text-center">VIGENCIA</th>
                        <th class="card-header text-center">MONTO</th>
                        <th class="card-header text-center">MONEDA</th>
                        <th class="card-header text-center">M√âTODO</th>
                        <th class="card-header text-center">MOTIVO DESC.</th>
                        <th class="card-header text-center"># FACTURA</th>
                        <th class="card-header text-center">Facturado</th> 
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_scripts %}
<script>
    let tablaPagos;
    const USER_ROLE = '{{ current_user.role }}';
    const CAN_MODIFY = USER_ROLE === 'SUPERADMIN' || USER_ROLE === 'ADMIN';

    // üõë FUNCI√ìN AJAX PARA GUARDAR FACTURA üõë
    async function updateFactura(pagoId, newNumber, dt) {
        if (!CAN_MODIFY) return; // Bloqueo de seguridad JS

        try {
            const resp = await fetch(`/api/pago/${pagoId}/factura`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numero_factura: newNumber })
            });
            const data = await resp.json();
            
            if (!data.ok) {
                Swal.fire('Error', data.error || 'No se pudo guardar el n√∫mero de factura.', 'error');
                dt.ajax.reload(null, false); // Recargar la tabla si falla
            }
        } catch (e) {
            Swal.fire('Error', 'Error de conexi√≥n al guardar factura.', 'error');
            dt.ajax.reload(null, false);
        }
    }

    $(function() {
        // Funci√≥n para calcular y actualizar el total
        function actualizarTotalGlobal(api) {
            const data = api.rows({ search: 'applied' }).data();
            let total = 0.0;

            data.each(function(row) {
                let montoLimpio = row.monto ? row.monto.toString().replace(/,/g, '') : '0';
                let valor = parseFloat(montoLimpio) || 0;
                total += valor;
            });

            $('#totalMontoGlobal').text(`$ ${total.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);
        }

        function loadPagosTable(year = '', month = '') {
            if ($.fn.DataTable.isDataTable('#tablaPagosGlobal')) {
                tablaPagos.destroy();
            }

            tablaPagos = $('#tablaPagosGlobal').DataTable({
                processing: true,
                serverSide: false, 
                // üõë A√ëADIENDO CONTROLES DE LONGITUD üõë
                pageLength: 25,
                lengthMenu: [
                    [10, 25, 50, -1],
                    ['10', '25', '50', 'Todos']
                ],
                dom: 'lBfrtip', // üõë AGREGAMOS 'l' PARA EL SELECT DE LONGITUD
                buttons: [
                    { extend: 'copyHtml5', text: '<i class="fa-regular fa-copy"></i> Copiar', className: 'btn btn-outline-secondary btn-sm' },
                    { extend: 'excelHtml5', text: '<i class="fa-solid fa-file-excel"></i> Excel', className: 'btn btn-outline-success btn-sm' },
                    { extend: 'csvHtml5', text: '<i class="fa-solid fa-file-csv"></i> CSV', className: 'btn btn-outline-primary btn-sm' },
                    { extend: 'print', text: '<i class="fa-solid fa-print"></i> Imprimir', className: 'btn btn-outline-dark btn-sm' }
                ],
                ajax: {
                    url: "{{ url_for('api_pagos_dt_global') }}",
                    type: "GET",
                    data: function (d) {
                        d.year = year;
                        d.month = month;
                    },
                    dataSrc: 'data'
                },
                columns: [
                    { data: 'id', visible: false, orderable: false },
                    { data: 'id_gumi' },
                    { data: 'server' },
                    { data: 'pais_cliente' },
                    { data: 'negocio_link' },
                    { data: 'contacto' },
                    { data: 'fecha_pago' },
                    { data: 'paquete' },
                    { data: 'vigencia' },
                    { data: 'monto', className: 'text-end' },
                    { data: 'moneda' },
                    { data: 'metodo_pago' },
                    { data: 'motivo_descuento' },
                    
                    // üõë COLUMNA # FACTURA CON EDICI√ìN IN-LINE üõë
                    { 
                        data: 'num_factura',
                        className: 'text-center',
                        render: function(data, type, row) {
                            const numFactura = data || '';
                            const disabledAttr = CAN_MODIFY ? '' : 'disabled'; // Seguridad
                            // Usamos un input para edici√≥n in-line
                            return `<input type="text" 
                                           class="form-control form-control-sm input-factura-inline" 
                                           value="${numFactura}" 
                                           data-id="${row.id}" 
                                           style="width:120px; text-align:center;"
                                           ${disabledAttr}>`;
                        }
                    },
                    
                    { data: 'facturado_str', visible: false }
                ],
                order: [[6, 'desc']],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
                },
                
                // üõë CONECTAMOS LA SUMA AL DIBUJADO DE LA TABLA üõë
                drawCallback: function() {
                    actualizarTotalGlobal(this.api());
                }
            });
        }

        // üõë LISTENER PARA GUARDADO IN-LINE (SE ACTIVA CADA VEZ QUE SE DEJA EL CAMPO) üõë
        $('#tablaPagosGlobal').on('blur', '.input-factura-inline', function() {
            if (!CAN_MODIFY) return; // Bloqueo de seguridad JS
            
            const input = $(this);
            const pagoId = input.data('id');
            const newValue = input.val().trim();
            
            const dtInstance = $('#tablaPagosGlobal').DataTable();

            updateFactura(pagoId, newValue, dtInstance);
        });
        
        loadPagosTable();

        $('#filtro_year, #filtro_month').on('change', function() {
            loadPagosTable($('#filtro_year').val(), $('#filtro_month').val());
        });
        
        $('#btn_reset_filtros').on('click', function() {
            $('#filtro_year').val('');
            $('#filtro_month').val('');
            loadPagosTable();
        });
    });
</script>
{% endblock %}